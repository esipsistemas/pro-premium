<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda Inteligente WhatsApp | ESIP-Sistemas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<style>
body{margin:0;font-family:Arial,sans-serif;background:#E9F7EF}

/* LICEN√áA */
#licencaBox{
 position:fixed;inset:0;background:#E9F7EF;
 display:flex;align-items:center;justify-content:center;z-index:9999
}
.licenca-card{
 background:#fff;padding:30px;border-radius:16px;
 width:90%;max-width:360px;text-align:center;
 box-shadow:0 10px 30px rgba(0,0,0,.2)
}
.licenca-card h2{color:#128C7E}
.licenca-card input{width:100%;padding:12px;border-radius:8px;border:1px solid #ccc}
.licenca-card button{
 width:100%;padding:14px;margin-top:10px;
 background:#25D366;color:#fff;border:none;border-radius:10px
}
#erroLicenca{color:#e74c3c}

/* SISTEMA */
header{background:#128C7E;color:#fff;padding:20px;text-align:center}
.container{
 max-width:1000px;margin:30px auto;background:#fff;
 padding:25px;border-radius:14px;box-shadow:0 8px 25px rgba(0,0,0,.12)
}
h2{text-align:center;color:#128C7E}

.form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px}
.form input,.form select,.form button{
 flex:1 1 22%;padding:10px;border-radius:8px;border:1px solid #ccc
}
.form button{background:#25D366;color:#fff;border:none;cursor:pointer}
.btn-foto{background:#128C7E;color:#fff}

ul{list-style:none;padding:0}
li{
 padding:12px;border-bottom:1px solid #eee;
 display:flex;justify-content:space-between;align-items:center
}
.contato{display:flex;gap:10px;align-items:center}
.avatar{width:45px;height:45px;border-radius:50%;object-fit:cover}

.btn-whatsapp{background:#25D366;color:#fff;border:none;border-radius:6px;padding:6px}
.btn-editar{background:#3498db;color:#fff;border:none;border-radius:6px;padding:6px}
.btn-excluir{background:#e74c3c;color:#fff;border:none;border-radius:6px;padding:6px}

.tag{padding:3px 6px;border-radius:6px;font-size:12px;color:#fff}
.tag.Lead{background:#3498db}
.tag.Cliente{background:#2ecc71}
.tag.VIP{background:#f1c40f;color:#000}
.tag.Cobran√ßa{background:#e74c3c}

.painel{
 display:grid;grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
 gap:12px;margin-bottom:20px
}
.card{background:#25D366;color:#fff;padding:18px;border-radius:14px;text-align:center}
.warning{color:#e74c3c;font-size:13px;margin-top:4px;}
</style>
</head>

<body>

<!-- LICEN√áA -->
<div id="licencaBox">
 <div class="licenca-card">
  <h2>üîê Ativa√ß√£o</h2>
  <input id="licencaInput" placeholder="DIGITE SUA LICEN√áA">
  <button onclick="validarLicenca()">ATIVAR</button>
  <small id="erroLicenca"></small>
 </div>
</div>

<header>
<h1>üí¨ Agenda Inteligente WhatsApp</h1>
<p>ESIP-Sistemas</p>
</header>

<div class="container">

<div class="painel">
 <div class="card">Total<br><b id="total">0</b></div>
 <div class="card">Leads<br><b id="leads">0</b></div>
 <div class="card">Clientes<br><b id="clientes">0</b></div>
 <div class="card">VIP<br><b id="vip">0</b></div>
</div>

<h2>Adicionar / Editar Contato</h2>

<div class="form">
 <input id="nome" placeholder="Nome">
 <input id="telefone" placeholder="Telefone">
 <input type="file" id="foto" accept="image/*" hidden>
 <button type="button" class="btn-foto" onclick="foto.click()">üì∑ Foto</button>
 <select id="tag">
  <option>Lead</option>
  <option>Cliente</option>
  <option>VIP</option>
  <option>Cobran√ßa</option>
 </select>
 <button onclick="salvarContato()">Salvar</button>
</div>

<div class="form">
 <input id="busca" placeholder="üîé Buscar por nome ou n√∫mero" oninput="buscar()">
</div>

<div class="form">
 <button onclick="backup()">üíæ Backup</button>
 <button onclick="restaurar()">‚ôªÔ∏è Restaurar</button>
 <small class="warning">‚ö†Ô∏è Restaurar apagar√° todos os contatos atuais!</small>
 <input type="file" id="backupFile" accept=".json" hidden>
</div>

<!-- LISTA -->
<ul id="lista"></ul>

</div>

<script>
/* =====================================================
   üîë EDITAR SOMENTE AQUI
   ===================================================== */
const LICENCAS_VALIDAS = [
 "ESIP-2025",
 "ESIP-2026",
 "ESIP-2027",
 "ESIP-2028",
 "ESIP-2029"
];

const deviceID = localStorage.getItem("deviceID") || Date.now()+"";
localStorage.setItem("deviceID", deviceID);

function validarLicenca(){
 const input = licencaInput.value.trim().toUpperCase();
 if(LICENCAS_VALIDAS.includes(input)){
  localStorage.setItem("licenca", input);
  localStorage.setItem("licenca_device", deviceID);
  licencaBox.style.display="none";
 }else{
  erroLicenca.innerText="Licen√ßa inv√°lida";
 }
}

if(LICENCAS_VALIDAS.includes(localStorage.getItem("licenca")) &&
   localStorage.getItem("licenca_device")===deviceID){
 licencaBox.style.display="none";
}

/* =====================================================
   ‚õî N√ÉO ALTERAR ABAIXO
   ===================================================== */

let contatos = JSON.parse(localStorage.getItem("contatos")) || [];
let editIndex = null;
const backupFileInput = document.getElementById("backupFile");

function salvar(){
 localStorage.setItem("contatos",JSON.stringify(contatos));
}

function atualizarPainel(){
 total.innerText = contatos.length;
 leads.innerText = contatos.filter(c=>c.tag==="Lead").length;
 clientes.innerText = contatos.filter(c=>c.tag==="Cliente").length;
 vip.innerText = contatos.filter(c=>c.tag==="VIP").length;
}

function render(listaFiltrada = contatos){
 const ul = document.getElementById("lista");
 ul.innerHTML="";
 listaFiltrada.forEach((c,i)=>{
  ul.innerHTML += `
  <li>
   <div class="contato">
    <img src="${c.foto || 'https://via.placeholder.com/45'}" class="avatar">
    <div>
     <b>${c.nome}</b><br>${c.telefone}
     <span class="tag ${c.tag}">${c.tag}</span>
    </div>
   </div>
   <div>
    <button class="btn-whatsapp" onclick="falar('${c.telefone}','${c.nome}')">üí¨</button>
    <button class="btn-editar" onclick="editar(${i})">‚úèÔ∏è</button>
    <button class="btn-excluir" onclick="excluir(${i})">‚úñ</button>
   </div>
  </li>`;
 });
 atualizarPainel();
}

function salvarContato(){
 const file = foto.files[0];
 const finalizar = (img)=>{
  const obj={nome:nome.value,telefone:telefone.value,tag:tag.value,foto:img};
  if(editIndex===null) contatos.push(obj);
  else contatos[editIndex]=obj;
  salvar();render();
  nome.value="";telefone.value="";foto.value="";editIndex=null;
 };
 if(file){
  const r=new FileReader();
  r.onload=()=>finalizar(r.result);
  r.readAsDataURL(file);
 }else finalizar(editIndex!==null?contatos[editIndex].foto:"");
}

function editar(i){
 const c=contatos[i];
 nome.value=c.nome;
 telefone.value=c.telefone;
 tag.value=c.tag;
 editIndex=i;
}

function excluir(i){
 contatos.splice(i,1);
 salvar();render();
}

function buscar(){
 const q=busca.value.toLowerCase();
 render(contatos.filter(c=>
  c.nome.toLowerCase().includes(q) ||
  c.telefone.includes(q)
 ));
}

function falar(n,nome){
 window.open(`https://wa.me/${n}?text=${encodeURIComponent("Ol√° "+nome)}`);
}

/* BACKUP */
function backup(){
 const b = new Blob([JSON.stringify({contatos,device:deviceID})], {type:"application/json"});
 const a = document.createElement("a");
 a.href = URL.createObjectURL(b);
 a.download = "backup-agenda-esip.json";
 a.click();
}

function restaurar(){
 if(confirm("‚ö†Ô∏è Aten√ß√£o! Isto apagar√° todos os contatos atuais.\nTem certeza que deseja continuar?")){
   backupFileInput.click();
 }
}

backupFileInput.onchange = function(){
 const r = new FileReader();
 r.onload = e => {
   const d = JSON.parse(e.target.result);
   if(d.device !== deviceID){
     alert("Backup n√£o pertence a este dispositivo");
     return;
   }
   contatos = d.contatos || [];
   salvar();
   render();
   alert("‚úÖ Contatos restaurados com sucesso!");
 };
 r.readAsText(this.files[0]);
};

/* MOSTRAR LISTA AO ABRIR */
render();
</script>

</body>
</html>
