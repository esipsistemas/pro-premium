<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8">
<title>Agenda Inteligente WhatsApp | ESIP-Sistemas</title>
<meta name="viewport" content="width=device-width, initial-scale=1.0">

<!-- jsPDF -->
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body{margin:0;font-family:Arial,sans-serif;background:#E9F7EF;}

/* MODAL LICEN√áA */
.modal{
 position:fixed;inset:0;background:rgba(0,0,0,.5);
 display:flex;align-items:center;justify-content:center;
 visibility:hidden;opacity:0;transition:.3s;z-index:9999;
}
.modal.active{visibility:visible;opacity:1;}
.modal-content{
 background:#fff;padding:30px;border-radius:16px;
 width:90%;max-width:380px;text-align:center;
 position:relative;
}
.modal-content h2{color:#128C7E;margin-bottom:15px;}
.modal-content input{width:100%;padding:12px;margin-bottom:10px;border-radius:8px;border:1px solid #ccc;}
.modal-content button{width:100%;padding:14px;background:#25D366;color:#fff;border:none;border-radius:10px;cursor:pointer;}
.warning{color:#e74c3c;font-size:13px;}
.close-modal{position:absolute;top:10px;right:15px;cursor:pointer;}

header{background:#128C7E;color:#fff;padding:20px;text-align:center;}
.container{max-width:1000px;margin:30px auto;background:#fff;padding:25px;border-radius:14px;box-shadow:0 8px 25px rgba(0,0,0,.12);}
h2{text-align:center;color:#128C7E;}

.form{display:flex;flex-wrap:wrap;gap:10px;margin-bottom:15px;}
.form input,.form select,.form button{flex:1 1 22%;padding:10px;border-radius:8px;border:1px solid #ccc;}
.form button{background:#25D366;color:#fff;border:none;cursor:pointer;}
.btn-foto{background:#128C7E;}

ul{list-style:none;padding:0;margin:0;}
li{padding:12px;border-bottom:1px solid #eee;display:flex;justify-content:space-between;align-items:center;}
.contato{display:flex;gap:10px;align-items:center;}
.avatar{width:45px;height:45px;border-radius:50%;object-fit:cover;}

.btn-whatsapp,.btn-editar,.btn-excluir{
 border:none;border-radius:6px;padding:6px;color:#fff;cursor:pointer;
}
.btn-whatsapp{background:#25D366;}
.btn-editar{background:#3498db;}
.btn-excluir{background:#e74c3c;}

.tag{padding:3px 6px;border-radius:6px;font-size:12px;color:#fff;}
.tag.Lead{background:#3498db;}
.tag.Cliente{background:#2ecc71;}
.tag.VIP{background:#f1c40f;color:#000;}
.tag.Cobran√ßa{background:#e74c3c;}

.painel{
 display:grid;
 grid-template-columns:repeat(auto-fit,minmax(150px,1fr));
 gap:12px;margin-bottom:20px;
}
.card{background:#25D366;color:#fff;padding:18px;border-radius:14px;text-align:center;}
</style>
</head>

<body>

<!-- MODAL LICEN√áA -->
<div class="modal" id="modalLicenca">
 <div class="modal-content">
  <span class="close-modal" onclick="closeModal()">‚úñ</span>
  <h2>üîê Ativa√ß√£o</h2>
  <input id="licencaInput" placeholder="Digite sua licen√ßa">
  <button type="button" onclick="validarLicenca()">Ativar</button>
  <small id="erroLicenca" class="warning"></small>
 </div>
</div>

<header>
<h1>üí¨ Agenda Inteligente WhatsApp</h1>
<p>ESIP-Sistemas</p>
</header>

<div class="container">

<div class="painel">
 <div class="card">Total<br><b id="total">0</b></div>
 <div class="card">Leads<br><b id="leads">0</b></div>
 <div class="card">Clientes<br><b id="clientes">0</b></div>
 <div class="card">VIP<br><b id="vip">0</b></div>
</div>

<h2>Adicionar / Editar Contato</h2>

<div class="form">
 <input id="nome" placeholder="Nome">
 <input id="telefone" placeholder="Telefone">
 <input type="file" id="foto" accept="image/*" hidden>
 <button type="button" class="btn-foto" onclick="foto.click()">üì∑ Foto</button>
 <select id="tag">
  <option>Lead</option>
  <option>Cliente</option>
  <option>VIP</option>
  <option>Cobran√ßa</option>
 </select>
 <button type="button" onclick="salvarContato()">Salvar</button>
</div>

<div class="form">
 <input id="busca" placeholder="üîé Buscar" oninput="buscar()">
</div>

<div class="form">
 <button type="button" onclick="exportarPDF()">üìÑ Exportar PDF</button>
</div>

<ul id="lista"></ul>
</div>

<script>
// ===== LICEN√áA =====
const LICENCAS_VALIDAS = ["ESIP-2025","ESIP-2026","ESIP-2027"];
const deviceID = localStorage.getItem("deviceID") || Date.now()+"";
localStorage.setItem("deviceID", deviceID);

const modalLicenca = document.getElementById("modalLicenca");
const licencaInput = document.getElementById("licencaInput");
const erroLicenca = document.getElementById("erroLicenca");

function showModal(){ modalLicenca.classList.add("active"); }
function closeModal(){ modalLicenca.classList.remove("active"); }

function validarLicenca(){
 const lic = licencaInput.value.trim().toUpperCase();
 if(LICENCAS_VALIDAS.includes(lic)){
  localStorage.setItem("licenca", lic);
  localStorage.setItem("licenca_device", deviceID);
  closeModal();
 }else{
  erroLicenca.innerText = "Licen√ßa inv√°lida";
 }
}

if(
 !LICENCAS_VALIDAS.includes(localStorage.getItem("licenca")) ||
 localStorage.getItem("licenca_device") !== deviceID
){
 showModal();
}

// ===== DOM =====
const nome = document.getElementById("nome");
const telefone = document.getElementById("telefone");
const foto = document.getElementById("foto");
const tag = document.getElementById("tag");
const busca = document.getElementById("busca");

const total = document.getElementById("total");
const leads = document.getElementById("leads");
const clientes = document.getElementById("clientes");
const vip = document.getElementById("vip");

// ===== DADOS =====
let contatos = JSON.parse(localStorage.getItem("contatos")) || [];
let editIndex = null;

// ===== UTIL =====
function salvar(){ localStorage.setItem("contatos", JSON.stringify(contatos)); }

function fileToBase64(file){
 return new Promise(resolve=>{
  const reader = new FileReader();
  reader.onload = e => resolve(e.target.result);
  reader.readAsDataURL(file);
 });
}

// ===== PAINEL =====
function atualizarPainel(){
 total.innerText = contatos.length;
 leads.innerText = contatos.filter(c=>c.tag==="Lead").length;
 clientes.innerText = contatos.filter(c=>c.tag==="Cliente").length;
 vip.innerText = contatos.filter(c=>c.tag==="VIP").length;
}

// ===== RENDER =====
function render(lista = contatos){
 const ul = document.getElementById("lista");
 ul.innerHTML = "";
 lista.forEach((c,i)=>{
  ul.innerHTML += `
  <li>
   <div class="contato">
    <img src="${c.foto || 'https://via.placeholder.com/45'}" class="avatar">
    <div>
     <b>${c.nome}</b><br>${c.telefone}
     <span class="tag ${c.tag}">${c.tag}</span>
    </div>
   </div>
   <div>
    <button class="btn-whatsapp" onclick="falar('${c.telefone}','${c.nome}')">üí¨</button>
    <button class="btn-editar" onclick="editar(${i})">‚úèÔ∏è</button>
    <button class="btn-excluir" onclick="excluir(${i})">‚úñ</button>
   </div>
  </li>`;
 });
 atualizarPainel();
}

// ===== CRUD =====
async function salvarContato(){
 let img = editIndex !== null ? contatos[editIndex].foto : "";
 if(foto.files[0]) img = await fileToBase64(foto.files[0]);

 const obj = { nome:nome.value, telefone:telefone.value, tag:tag.value, foto:img };

 if(editIndex === null) contatos.push(obj);
 else contatos[editIndex] = obj;

 salvar(); render();
 nome.value=""; telefone.value=""; foto.value=""; editIndex=null;
}

function editar(i){
 const c = contatos[i];
 nome.value = c.nome;
 telefone.value = c.telefone;
 tag.value = c.tag;
 editIndex = i;
}

function excluir(i){
 if(confirm("Excluir contato?")){
  contatos.splice(i,1);
  salvar(); render();
 }
}

function buscar(){
 const q = busca.value.toLowerCase();
 render(contatos.filter(c=>c.nome.toLowerCase().includes(q)||c.telefone.includes(q)));
}

function falar(n,nome){
 window.open(`https://wa.me/${n}?text=${encodeURIComponent("Ol√° "+nome)}`);
}

// ===== PDF =====
function exportarPDF(){
 const { jsPDF } = window.jspdf;
 const doc = new jsPDF();

 doc.setFontSize(16);
 doc.text("Agenda Inteligente WhatsApp",15,15);
 doc.setFontSize(11);

 let y = 30;

 contatos.forEach(c=>{
  if(y > 260){ doc.addPage(); y = 20; }

  if(c.foto) doc.addImage(c.foto,"JPEG",15,y-5,20,20);
  doc.text(`Nome: ${c.nome}`,40,y);
  doc.text(`Telefone: ${c.telefone}`,40,y+7);
  doc.text(`Tag: ${c.tag}`,40,y+14);
  y += 28;
 });

 doc.save("agenda.pdf");
}

render();
</script>

</body>
</html>

