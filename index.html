<!DOCTYPE html>
<html lang="pt-BR">
<head>
<meta charset="UTF-8" />
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>ğŸ“¡ ESIP - Sistemas</title>

<script src="https://unpkg.com/html5-qrcode"></script>
<script src="https://cdnjs.cloudflare.com/ajax/libs/jspdf/2.5.1/jspdf.umd.min.js"></script>

<style>
body {
    background:#1a0000;
    color:#fff;
    font-family:Arial,sans-serif;
    text-align:center;
    margin:0;
    padding-bottom:40px;
}
#reader{width:350px;margin:20px auto;border:4px solid #ff0000;border-radius:12px}
.btn{background:#ff0000;color:#fff;padding:12px;border:none;border-radius:10px;font-size:16px;margin:8px auto;width:90%}
.btn:disabled{opacity:.5}
.counter-box{display:inline-block;background:#330000;border:2px solid #ff0000;padding:8px 12px;border-radius:10px;margin:4px}
.badge{display:inline-block;margin:5px;padding:8px 14px;border-radius:30px;background:#003314;border:1px solid #00ff88}
.green{color:#00ff88}
.red{color:#ff4444}
</style>
</head>

<body>

<h2>ğŸ“¡ ESIP - Sistemas</h2>

<div>
  <div class="counter-box">VÃ¡lidos: <span id="countValid">0</span></div>
  <div class="counter-box">Usados: <span id="countUsed">0</span></div>
  <div class="counter-box">InvÃ¡lidos: <span id="countInvalid">0</span></div>
  <div class="counter-box">ğŸ§  MemÃ³ria: <span id="countMemory">0</span></div>
</div>

<div id="reader"></div>

<button id="toggleLight" class="btn">ğŸ”¦ Lanterna</button>
<button id="switchCam" class="btn">ğŸ”„ Trocar CÃ¢mera</button>

<input id="searchInput" placeholder="ğŸ” Buscar por ID">
<button id="searchBtn" class="btn">ğŸ” Buscar</button>

<button id="resetBtn" class="btn">ğŸ—‘ï¸ Resetar</button>
<button id="exportCSV" class="btn">ğŸ“¤ Exportar CSV</button>
<button id="exportPDF" class="btn">ğŸ“„ Exportar PDF</button>

<div id="msg"></div>

<h3>ğŸ“œ HistÃ³rico</h3>
<div id="historyBox"></div>

<script>
const countValid = document.getElementById("countValid");
const countUsed = document.getElementById("countUsed");
const countInvalid = document.getElementById("countInvalid");
const countMemory = document.getElementById("countMemory");
const historyBox = document.getElementById("historyBox");

let html5Qr, cameras=[], currentCam=0, flashOn=false;
let usedMap = JSON.parse(localStorage.getItem("usedMap")||"{}");

function isIOS(){ return /iPhone|iPad|iPod/.test(navigator.userAgent); }

function updateCounters(){
  countValid.textContent = Object.keys(usedMap).length;
  countMemory.textContent = Object.keys(usedMap).length;
}

function updateHistory(){
  historyBox.innerHTML="";
  for(const c in usedMap){
    const d=document.createElement("div");
    d.className="badge";
    d.textContent=c;
    historyBox.appendChild(d);
  }
}

function showMsg(t,ok){
  msg.textContent=t;
  msg.className=ok?"green":"red";
}

async function startScanner(){
  html5Qr=new Html5Qrcode("reader");
  cameras=await Html5Qrcode.getCameras();
  if(!cameras.length)return;

  const cam=cameras.find(c=>c.label.toLowerCase().includes("back"))||cameras[0];
  currentCam=cameras.indexOf(cam);

  await html5Qr.start(cam.id,{fps:10,qrbox:250},onScan);
  protectTorch();
}

function onScan(text){
  if(usedMap[text]){
    showMsg("âš ï¸ JÃ¡ usado",false);
    return;
  }
  usedMap[text]=Date.now();
  localStorage.setItem("usedMap",JSON.stringify(usedMap));
  updateCounters();
  updateHistory();
  showMsg("âœ… VÃ¡lido",true);
}

function protectTorch(){
  const btn=toggleLight;
  const track=html5Qr.getRunningTrack();
  if(isIOS() || !track?.getCapabilities?.().torch){
    btn.disabled=true;
    btn.textContent="ğŸ”¦ IndisponÃ­vel";
  }
}

toggleLight.onclick=async()=>{
  const track=html5Qr.getRunningTrack();
  if(!track)return;
  flashOn=!flashOn;
  await track.applyConstraints({advanced:[{torch:flashOn}]});
};

switchCam.onclick=async()=>{
  flashOn=false;
  await html5Qr.stop();
  currentCam=(currentCam+1)%cameras.length;
  startScanner();
};

searchBtn.onclick=()=>{
  const c=searchInput.value.trim();
  showMsg(usedMap[c]?"âœ… Usado":"âŒ NÃ£o usado",!!usedMap[c]);
};

resetBtn.onclick=()=>{
  localStorage.clear();
  location.reload();
};

updateCounters();
updateHistory();
startScanner();
</script>

</body>
</html>

